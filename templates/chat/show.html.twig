{% extends 'front/base.html.twig' %}

{% block title %}Conversation{% endblock %}

{% block body %}
<div style="max-width:900px;margin:40px auto;">

    <h2>ðŸ’¬ Conversation</h2>

    <div id="chatBox"
         style="border:1px solid #ddd;
                height:400px;
                overflow-y:auto;
                padding:15px;
                margin-bottom:15px;
                background:#fafafa;">

        {% for message in messages %}
            <div style="margin-bottom:10px;">
                <strong>{{ message.sender.prenom }}</strong> :
                {{ message.content }}
                <small style="color:gray;font-size:11px;">
                    {{ message.createdAt|date('H:i') }}
                </small>
            </div>
        {% endfor %}

    </div>

    <div style="display:flex;gap:10px;">
        <input type="text"
               id="msgInput"
               placeholder="Tapez votre message..."
               style="flex:1;padding:10px;border:1px solid #ccc;border-radius:6px;">

        <button id="sendBtn"
                style="padding:10px 20px;background:#7c3aed;color:white;border:none;border-radius:6px;">
            Envoyer
        </button>
    </div>

</div>

{# ===============================
   SAFE TWIG VARIABLES
================================ #}

{% set otherUserId =
    conversation.owner.id == app.user.id
        ? conversation.gardien.id
        : conversation.owner.id
%}
<script>

// ===============================
// GLOBAL CONVERSATION ID (used by base WS)
// ===============================
window.currentConversationId = {{ conversation.id|default(0) }};

// ===============================
// SEND MESSAGE
// ===============================
document.addEventListener("DOMContentLoaded", function () {

    const sendBtn = document.getElementById("sendBtn");
    const input = document.getElementById("msgInput");
    const chatBox = document.getElementById("chatBox");

    if (!sendBtn || !input || !chatBox) return;

    sendBtn.addEventListener("click", sendMessage);

    // Optional: press Enter to send
    input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {

        const content = input.value.trim();
        if (!content) return;

        fetch("{{ path('conversation_send', {id: conversation.id}) }}", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "content=" + encodeURIComponent(content)
        })
        .then(res => res.json())
        .then(data => {

            if (data.success) {

                // Show instantly on sender side
                appendMessage("{{ app.user.prenom }}", content);
                input.value = "";
            }
        });
    }

    // Scroll to bottom on load
    chatBox.scrollTop = chatBox.scrollHeight;

});

// ===============================
// APPEND MESSAGE (GLOBAL)
// ===============================
function appendMessage(sender, content) {

    const chatBox = document.getElementById("chatBox");
    if (!chatBox) return;

    const div = document.createElement("div");
    div.style.marginBottom = "10px";

    div.innerHTML =
        "<strong>" + sender + "</strong> : " +
        escapeHtml(content);

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ===============================
// SIMPLE ESCAPE
// ===============================
function escapeHtml(text) {
    const div = document.createElement("div");
    div.innerText = text;
    return div.innerHTML;
}

</script>

{% endblock %}