{% extends 'front/base.html.twig' %}

{% block title %}Mes Annonces{% endblock %}

{% block body %}
<section class="content">
    <div class="card" style="width:100%;">

        <!-- HEADER -->
        <div class="table-header">
            <h2>üì¢ Mes Annonces</h2>
            <a href="{{ path('app_announcement_new') }}" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> Nouvelle annonce
            </a>
        </div>

        <!-- SEARCH BAR -->
        <form method="get" class="search-bar" id="filterForm">
            <input type="text" name="address" placeholder="üîç Adresse">
            <input type="date" name="dateDebut">
            <input type="date" name="dateFin">
            <button type="submit" class="btn-search">Rechercher</button>
            <button type="button" id="resetFilters" class="btn-reset">R√©initialiser</button>
        </form>

        <!-- TABLE -->
        <div class="table-wrapper">
            <table class="pet-table">
                <thead>
                    <tr>
                        <th>Animal</th>
                        <th>Type de garde</th>
                        <th>Visites</th>
                        <th>Horaires</th>
                        <th>Date d√©but</th>
                        <th>Date fin</th>
                        <th>R√©mun√©ration min</th>
                        <th>R√©mun√©ration max</th>
                        <th>Adresse</th>
                        <th>Services</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                {% for announcement in announcements %}
                    <tr>
                        {# Animal #}
                        <td>
                          {% if announcement.pet %}
    {{ announcement.pet.name }} ({{ announcement.pet.typePet.value|lower }})
{% endif %}
                        </td>

                        {# Type de garde #}
                       {# Type de garde #}
<td>
    {% if announcement.careType %}
        {% if announcement.careType.value == 'CHEZ_MOI' %}
            Chez moi
        {% elseif announcement.careType.value == 'CHENIL' %}
            Chenil
        {% else %}
            {{ announcement.careType.value }}
        {% endif %}
    {% else %}
        ---
    {% endif %}
</td>

                        {# Visites par jour #}
                       
<td>
    {% if announcement.careType 
        and announcement.careType.value == 'CHEZ_MOI' 
        and announcement.visitPerDay is not empty %}
        
        {{ announcement.visitPerDay }} /jour
    {% else %}
        ---
    {% endif %}
</td>
                        {# Horaires de visite #}
                        <td>
    {% if announcement.careType and announcement.careType.value == 'CHEZ_MOI' and announcement.visitHours %}
        {% for horaire in announcement.visitHours %}
            {{ horaire }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    {% else %}
        ---
    {% endif %}
</td>

                        {# Dates #}
                        <td>{{ announcement.dateDebut ? announcement.dateDebut|date('d/m/Y') : '' }}</td>
                        <td>{{ announcement.dateFin ? announcement.dateFin|date('d/m/Y') : '' }}</td>

                        {# R√©mun√©ration #}
                        <td>{{ announcement.renumerationMin }} ‚Ç¨</td>
                        <td>{{ announcement.renumerationMax ? announcement.renumerationMax ~ ' ‚Ç¨' : '---' }}</td>

                        {# Adresse #}
                        <td>{{ announcement.address }}</td>

                        {# Services #}
                        <td>{{ announcement.services ?: '---' }}</td>

                        {# Actions #}
                        <td>
                            <a href="{{ path('app_announcement_edit', {'id': announcement.id}) }}" class="btn btn-sm btn-primary">‚úèÔ∏è</a>
                            <form method="post" action="{{ path('app_announcement_delete', {'id': announcement.id}) }}"
                                  class="delete-form" data-item-name="{{ announcement.pet ? announcement.pet.name : 'cette annonce' }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete_announcement_' ~ announcement.id) }}">
                                <button type="button" class="open-delete-modal btn btn-sm btn-danger">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="11">Aucune annonce trouv√©e.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</section>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Supprimer l‚Äôannonce</h3>
        <p id="deleteMessage"></p>
        <div class="modal-actions">
            <button id="cancelDelete" class="btn-cancel">Annuler</button>
            <button id="confirmDelete" class="btn-danger">Supprimer</button>
        </div>
    </div>
</div>

{% block javascripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('filterForm');
    const resetBtn = document.getElementById('resetFilters');
    const tableBodySelector = '.pet-table tbody';

    function fetchFilteredData() {
        const params = new URLSearchParams(new FormData(form));
        fetch('/announcement/filter?' + params.toString())
            .then(response => response.text())
            .then(html => {
                document.querySelector(tableBodySelector).outerHTML = html;
                attachDeleteEvents();
            });
    }

    form.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', fetchFilteredData);
        input.addEventListener('keyup', fetchFilteredData);
    });

    resetBtn.addEventListener('click', function () {
        form.querySelectorAll('input').forEach(el => el.value = '');
        fetchFilteredData();
    });

    const modal = document.getElementById('deleteModal');
    const deleteMessage = document.getElementById('deleteMessage');
    const confirmBtn = document.getElementById('confirmDelete');
    const cancelBtn = document.getElementById('cancelDelete');
    let currentForm = null;

    function attachDeleteEvents() {
        document.querySelectorAll('.open-delete-modal').forEach(button => {
            button.addEventListener('click', function() {
                currentForm = this.closest('.delete-form');
                const itemName = currentForm.dataset.itemName;
                deleteMessage.innerText = 'Voulez-vous vraiment supprimer "' + itemName + '" ?';
                modal.style.display = "flex";
            });
        });
    }

    attachDeleteEvents();

    cancelBtn.addEventListener('click', function() {
        modal.style.display = "none";
        currentForm = null;
    });

    confirmBtn.addEventListener('click', function() {
        if (currentForm) {
            currentForm.submit();
        }
    });

    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
});
</script>
{% endblock %}

{% endblock %}