{% extends 'front/base.html.twig' %}

{% block title %}Mes Annonces{% endblock %}

{% block body %}
<section class="content">
    <div class="card" style="width:100%;">

        <!-- HEADER -->
        <div class="table-header">
            <h2>ðŸ“¢ Mes Annonces</h2>
            <a href="{{ path('app_announcement_new') }}" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> Nouvelle annonce
            </a>
        </div>

        <!-- SEARCH BAR -->
        <form method="get" class="search-bar" id="filterForm">
            <input type="text" name="address" placeholder="ðŸ” Adresse">

            <input type="date" name="dateDebut">
            <input type="date" name="dateFin">

            <button type="submit" class="btn-search">Rechercher</button>

            <button type="button" id="resetFilters" class="btn-reset">
                RÃ©initialiser
            </button>
        </form>

        <!-- TABLE -->
        <div class="table-wrapper">
            <table class="pet-table">
                <thead>
                    <tr>
                        <th>Adresse</th>
                        <th>Type</th>
                        <th>Date dÃ©but</th>
                        <th>Date fin</th>
                        <th>Visites</th>
                        <th>Min</th>
                        <th>Max</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                {% include 'announcement/_table.html.twig' %}
            </table>
        </div>

    </div>
</section>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Supprimer lâ€™annonce</h3>
        <p id="deleteMessage"></p>

        <div class="modal-actions">
            <button id="cancelDelete" class="btn-cancel">Annuler</button>
            <button id="confirmDelete" class="btn-danger">Supprimer</button>
        </div>
    </div>
</div>

{% block javascripts %}
<script>

document.addEventListener("DOMContentLoaded", function() {

    const form = document.getElementById('filterForm');
    const resetBtn = document.getElementById('resetFilters');
    const tableBodySelector = '.pet-table tbody';

    /* =========================
       AJAX FILTER FUNCTION
    ========================== */
    function fetchFilteredData() {

        const params = new URLSearchParams(new FormData(form));

        fetch('/announcement/filter?' + params.toString())
            .then(response => response.text())
            .then(html => {
                document.querySelector(tableBodySelector).outerHTML = html;
                attachDeleteEvents();
            });
    }

    /* =========================
       LIVE FILTER ON INPUT CHANGE
    ========================== */
    form.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', fetchFilteredData);
        input.addEventListener('keyup', fetchFilteredData);
    });

    /* =========================
       RESET FILTERS
    ========================== */
    resetBtn.addEventListener('click', function () {

        form.querySelectorAll('input').forEach(el => el.value = '');

        fetchFilteredData();
    });

    /* =========================
       DELETE MODAL LOGIC
    ========================== */

    const modal = document.getElementById('deleteModal');
    const deleteMessage = document.getElementById('deleteMessage');
    const confirmBtn = document.getElementById('confirmDelete');
    const cancelBtn = document.getElementById('cancelDelete');

    let currentForm = null;

    function attachDeleteEvents() {
        document.querySelectorAll('.open-delete-modal').forEach(button => {
            button.addEventListener('click', function() {

                currentForm = this.closest('.delete-form');
                const itemName = currentForm.dataset.itemName;

                deleteMessage.innerText =
                    'Voulez-vous vraiment supprimer "' + itemName + '" ?';

                modal.style.display = "flex";
            });
        });
    }

    attachDeleteEvents();

    cancelBtn.addEventListener('click', function() {
        modal.style.display = "none";
        currentForm = null;
    });

    confirmBtn.addEventListener('click', function() {
        if (currentForm) {
            currentForm.submit();
        }
    });

    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });

});
</script>
{% endblock %}

{% endblock %}
